name: Deploy to VPS

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Decode Base64 SSH Key
      - name: ðŸ” Decode SSH Private Key
        run: |
          echo "${{ secrets.VPS_SSH_KEY_BASE64 }}" | base64 -d > private_key
          chmod 600 private_key

      # Deploy via SSH
      - name: ðŸš€ Deploy to VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key_path: private_key
          port: 22
          script: |
            set -e

            echo "âœ… Connected to VPS"
            whoami

            PROJECT_DIR="/home/${{ secrets.VPS_USER }}/public_html/HKConstructionweb"

            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ Project directory does not exist!"
              exit 1
            fi

            cd $PROJECT_DIR

            echo "ðŸ“¦ Pulling latest code..."
            git pull origin main

            echo "ðŸ“¦ Installing dependencies..."
            yarn install --frozen-lockfile || yarn install

            echo "ðŸ— Building project..."
            yarn build

            echo "ðŸ”„ Reloading PM2..."
            if pm2 describe hk-web > /dev/null; then
              pm2 reload hk-web
            else
              pm2 start npm --name "hk-web" -- run start
            fi

            pm2 save

            echo "ðŸŽ‰ Deployment Successful!"
