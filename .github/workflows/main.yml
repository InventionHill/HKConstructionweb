name: Deploy to VPS

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ðŸ”Ž Debug Secrets (Safe check)
      - name: ðŸ” Debug Secret Presence
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "âŒ VPS_HOST is EMPTY"
            exit 1
          fi

          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "âŒ VPS_USER is EMPTY"
            exit 1
          fi

          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ VPS_SSH_KEY is EMPTY"
            exit 1
          fi

          echo "âœ… All required secrets are present"

      - name: ðŸš€ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          debug: true
          script: |
            set -e

            echo "=================================="
            echo "âœ… Connected to VPS"
            echo "=================================="

            echo "ðŸ‘¤ Current User:"
            whoami

            echo "ðŸ“ Current Directory:"
            pwd

            echo "ðŸŸ¢ Node Version:"
            node -v || echo "Node not found"

            echo "ðŸŸ¢ Yarn Version:"
            yarn -v || echo "Yarn not found"

            echo "ðŸ“¦ Loading NVM if exists..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            PROJECT_DIR="/home/${{ secrets.VPS_USER }}/public_html/HKConstructionweb"

            echo "ðŸ“‚ Checking Project Directory..."
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ Project directory does not exist!"
              exit 1
            fi

            cd $PROJECT_DIR

            echo "ðŸ“¦ Pulling latest code..."
            git pull origin main

            echo "ðŸ§¹ Removing old lock file..."
            rm -f package-lock.json

            echo "ðŸ“¦ Installing dependencies..."
            yarn install --frozen-lockfile || yarn install

            echo "ðŸ— Building project..."
            yarn build

            echo "ðŸ”„ Restarting PM2..."
            if pm2 describe hk-web > /dev/null; then
              pm2 reload hk-web
            else
              pm2 start npm --name "hk-web" -- run start
            fi

            pm2 save

            echo "=================================="
            echo "ðŸŽ‰ Deployment Successful!"
            echo "=================================="
